/**
 * @file 语音识别组件
 * @author swan
 */

/* globals Page, swan, getApp masterManager */
import {TIPS, BTN_TEXT, JUSTIFY_CONTENT, PERM_TIPS} from './const';
import {isFullScreen} from '../../common/utils/index.js';
let {platform} = swan.getSystemInfoSync();
Component({
    externalClasses: [
        'gov-mark',
        'gov-voice-panel',
        'gov-btn-voice',
        'gov-word-box'
    ],
    properties: {
        longSpeech: {
            type: Boolean,
            value: false
        },
        mode: {
            type: String,
            value: 'dnn'
        },
        context: {
            type: String,
            value: 'input'
        },
        defaultText: {
            type: String,
            value: TIPS.DEFAULT_TEXT
        },
        showPanel: {
            type: Boolean,
            value: false,
            observer: function (newVal, oldVal) {
                newVal && this.triggerStart();
            }
        },
        hasTabBar: {
            type: Boolean,
            value: false
        }
    },
    data: {
        btnText: BTN_TEXT.END,
        platform,
        content: '',
        eventType: '',
        showAnimate: 0,
        verticalAlign: JUSTIFY_CONTENT.NORMAL,
        animateParam: {
            transformOrigin: '50% 50%',
            duration: 500,
            timingFunction: 'ease',
            delay: 0
        },
        animate: true,
        isFullScreen,
        /* eslint-disable max-len */
        iconVoice: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAQAAABJXchjAAABz0lEQVR4Ae3ZIZDiMBjF8U9GrqxERiIrkZWVJ5GVyJWVSGQlciUSiaysRFZGVsb9z3A7mSMcSSftic3PMjBvHm+GJkiWWpahqOgYMFgMAx0VStZEg+GZoZF1sGHgtYGNLI0Sw78ZyqVbMLxnFm2DgTDDknMM18gSUBjCGZSkR0WcStKjI063zijXHyeGOEbSI1oO8ZBD5BA5RA6RQ+QQE3EmSY87ce5pzhhaHFyJc5VvfDJi6FASDsX170MdB+IcPO88SzhO/HFzmomz8TwYWtS8738nD1wId5EHahwSjpv34zSWMBbt3dJ1/oFPx+7C2UOJq44b5gTOLr5x5j1nfvTMPxpyxLX3vuJ3FPE3RytxKNwusO7FBzUjfqNbODus2wMfEovm9cUHigM9Lug5uHWjMZ42Y9HjGtk+tVXT8ElDTfHmWqmXedgy4ZpC180vJk+Pye4kvijerukCuCy71FdEEye0eKHpsAtcHXHAp+dIheYDRcGWmhMDzyx7SYEayzyWSlKh5E68ga2khKLFEs7SoiQ9NF/YoABntCyHgpaR1+60FGvd9O8544YZObNnI2uj9fxC/uwQOUSz5F8L8U9fE4X8L5TcmLhRSpYl9Bssrsq1I0MogQAAAABJRU5ErkJggg=='
        /* eslint-enable max-len */
    },
    attached() {
        this.voiceRecognizer = swan.ai.getVoiceRecognizer();
        this.voiceRecognizer.stop();
        this.setData({
            msg: this.data.defaultText
        });
    },
    methods: {
        triggerStart() {
            this.setData({
                eventType: 'start'
            });

            this.data.hasTabBar && swan.hideTabBar({
                animation: true
            });
            this.startAnimation();
            this.start();
        },
        start() {
            this.voiceRecognizer.onStart(() => {
                this.setData({
                    eventType: 'stop',
                    btnText: BTN_TEXT.END,
                    showAnimate: 0,
                    msg: this.data.defaultText
                });
            });

            this.voiceRecognizer.onRecognize(res => {
                let showAnimate = res.result ? 1 : 0;
                this.setData({
                    content: res.result,
                    showAnimate,
                    msg: ''
                }, () => {
                    let query = swan.createSelectorQuery();
                    query.in(this).select('.result-cont').boundingClientRect(res => {
                        if (res.height > 60 && JUSTIFY_CONTENT.MORE !== this.data.verticalAlign) {
                            this.setData({
                                verticalAlign: JUSTIFY_CONTENT.MORE,
                                delMargin: true
                            });
                        }
                    }).exec();
                });
            });

            this.voiceRecognizer.onFinish(res => {
                this.setData({
                    content: res.result
                });
                this.stop();
            });

            this.voiceRecognizer.onError(err => {
                if (err.errorCode === 2004 || err.errorCode === 2005) {
                    this.setData({
                        showPanel: false
                    });
                    swan.showModal({
                        title: PERM_TIPS.TITLE,
                        content: PERM_TIPS.CONTENT,
                        showCancel: false,
                        confirmText: PERM_TIPS.BTN_TEXT
                    });
                }
                err.errorMsg = this.promptConversion(err.errorCode, err.errorMsg);
                this.setData({
                    msg: err.errorMsg,
                    showAnimate: 2
                });
                this.errInit();
                this.voiceRecognizer.stop();
            });
            let {mode, longSpeech, context} = this.data;

            this.voiceRecognizer.start({mode, longSpeech, context});
        },
        stop() {
            let content = this.data.content;
            if (content) {
                setTimeout(() => {
                    this.triggerEvent('stop', {content});
                }, 300);
                this.finish();
            }
            else {
                this.setData({
                    msg: TIPS.RETRY,
                    btnText: BTN_TEXT.START,
                    eventType: 'start',
                    showAnimate: 2
                });
                this.voiceRecognizer.stop();
            }
        },
        finish() {
            this.voiceRecognizer.stop();
            this.endAnimation();
        },
        cancel() {
            this.voiceRecognizer.cancel();
            this.endAnimation(() => {
                this.triggerEvent('cancelend');
            });
        },
        startAnimation() {
            const animation = swan.createAnimation(this.data.animateParam);
            animation.translateY(0).step();
            this.setData({
                animationData: animation.export()
            });
        },
        endAnimation(callback) {
            const animation = swan.createAnimation(this.data.animateParam);
            animation.translateY(290).step();
            this.setData({
                animationData: animation.export()
            }, () => {
                setTimeout(() => {
                    this.panelInit();
                    this.data.hasTabBar && swan.showTabBar({
                        animation: true
                    });
                    callback && callback();
                }, 200);
            });
        },
        panelInit() {
            this.setData({
                showPanel: false,
                showAnimate: 0,
                verticalAlign: JUSTIFY_CONTENT.NORMAL,
                content: '',
                msg: this.data.defaultText,
                btnText: BTN_TEXT.END,
                eventType: '',
                delMargin: false
            });
        },
        errInit() {
            this.setData({
                verticalAlign: JUSTIFY_CONTENT.NORMAL,
                content: '',
                btnText: BTN_TEXT.START,
                eventType: 'start',
                delMargin: false
            });
        },
        promptConversion(errCode, errorMsg) {
            let text = '';
            switch (errCode) {
                case 2001:
                    text = TIPS.ABNORMAL_MIKE;
                    break;
                case 2002:
                    text = TIPS.RETRY;
                    break;
                case 2003:
                    text = TIPS.TOO_SHORT;
                    break;
                case 2004:
                case 2005:
                    text = '';
                    break;
                case 1001:
                case 2009:
                case 3001:
                case 3002:
                case 9000:
                    text = TIPS.TRY_AGIN;
                    break;
                case 4002:
                    text = TIPS.TOO_LONG;
                    break;
                case 4001:
                case 4003:
                case 4004:
                    text = TIPS.FAIL;
                    break;
                default:
                    text = errorMsg;
            }
            return text;
        }
    }
});
