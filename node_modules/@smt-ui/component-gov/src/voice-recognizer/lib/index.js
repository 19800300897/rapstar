"use strict";

var _const = require("./const");

var _index = require("../../common/utils/index.js");

/**
 * @file 语音识别组件
 * @author swan
 */

/* globals Page, swan, getApp masterManager */
var _swan$getSystemInfoSy = swan.getSystemInfoSync(),
    platform = _swan$getSystemInfoSy.platform;

Component({
  externalClasses: ['gov-mark', 'gov-voice-panel', 'gov-btn-voice', 'gov-word-box'],
  properties: {
    longSpeech: {
      type: Boolean,
      value: false
    },
    mode: {
      type: String,
      value: 'dnn'
    },
    context: {
      type: String,
      value: 'input'
    },
    defaultText: {
      type: String,
      value: _const.TIPS.DEFAULT_TEXT
    },
    showPanel: {
      type: Boolean,
      value: false,
      observer: function observer(newVal, oldVal) {
        newVal && this.triggerStart();
      }
    },
    hasTabBar: {
      type: Boolean,
      value: false
    }
  },
  data: {
    btnText: _const.BTN_TEXT.END,
    platform: platform,
    content: '',
    eventType: '',
    showAnimate: 0,
    verticalAlign: _const.JUSTIFY_CONTENT.NORMAL,
    animateParam: {
      transformOrigin: '50% 50%',
      duration: 500,
      timingFunction: 'ease',
      delay: 0
    },
    animate: true,
    isFullScreen: _index.isFullScreen,

    /* eslint-disable max-len */
    iconVoice: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAQAAABJXchjAAABz0lEQVR4Ae3ZIZDiMBjF8U9GrqxERiIrkZWVJ5GVyJWVSGQlciUSiaysRFZGVsb9z3A7mSMcSSftic3PMjBvHm+GJkiWWpahqOgYMFgMAx0VStZEg+GZoZF1sGHgtYGNLI0Sw78ZyqVbMLxnFm2DgTDDknMM18gSUBjCGZSkR0WcStKjI063zijXHyeGOEbSI1oO8ZBD5BA5RA6RQ+QQE3EmSY87ce5pzhhaHFyJc5VvfDJi6FASDsX170MdB+IcPO88SzhO/HFzmomz8TwYWtS8738nD1wId5EHahwSjpv34zSWMBbt3dJ1/oFPx+7C2UOJq44b5gTOLr5x5j1nfvTMPxpyxLX3vuJ3FPE3RytxKNwusO7FBzUjfqNbODus2wMfEovm9cUHigM9Lug5uHWjMZ42Y9HjGtk+tVXT8ElDTfHmWqmXedgy4ZpC180vJk+Pye4kvijerukCuCy71FdEEye0eKHpsAtcHXHAp+dIheYDRcGWmhMDzyx7SYEayzyWSlKh5E68ga2khKLFEs7SoiQ9NF/YoABntCyHgpaR1+60FGvd9O8544YZObNnI2uj9fxC/uwQOUSz5F8L8U9fE4X8L5TcmLhRSpYl9Bssrsq1I0MogQAAAABJRU5ErkJggg=='
    /* eslint-enable max-len */

  },
  attached: function attached() {
    this.voiceRecognizer = swan.ai.getVoiceRecognizer();
    this.voiceRecognizer.stop();
    this.setData({
      msg: this.data.defaultText
    });
  },
  methods: {
    triggerStart: function triggerStart() {
      this.setData({
        eventType: 'start'
      });
      this.data.hasTabBar && swan.hideTabBar({
        animation: true
      });
      this.startAnimation();
      this.start();
    },
    start: function start() {
      var _this = this;

      this.voiceRecognizer.onStart(function () {
        _this.setData({
          eventType: 'stop',
          btnText: _const.BTN_TEXT.END,
          showAnimate: 0,
          msg: _this.data.defaultText
        });
      });
      this.voiceRecognizer.onRecognize(function (res) {
        var showAnimate = res.result ? 1 : 0;

        _this.setData({
          content: res.result,
          showAnimate: showAnimate,
          msg: ''
        }, function () {
          var query = swan.createSelectorQuery();
          query["in"](_this).select('.result-cont').boundingClientRect(function (res) {
            if (res.height > 60 && _const.JUSTIFY_CONTENT.MORE !== _this.data.verticalAlign) {
              _this.setData({
                verticalAlign: _const.JUSTIFY_CONTENT.MORE,
                delMargin: true
              });
            }
          }).exec();
        });
      });
      this.voiceRecognizer.onFinish(function (res) {
        _this.setData({
          content: res.result
        });

        _this.stop();
      });
      this.voiceRecognizer.onError(function (err) {
        if (err.errorCode === 2004 || err.errorCode === 2005) {
          _this.setData({
            showPanel: false
          });

          swan.showModal({
            title: _const.PERM_TIPS.TITLE,
            content: _const.PERM_TIPS.CONTENT,
            showCancel: false,
            confirmText: _const.PERM_TIPS.BTN_TEXT
          });
        }

        err.errorMsg = _this.promptConversion(err.errorCode, err.errorMsg);

        _this.setData({
          msg: err.errorMsg,
          showAnimate: 2
        });

        _this.errInit();

        _this.voiceRecognizer.stop();
      });
      var _this$data = this.data,
          mode = _this$data.mode,
          longSpeech = _this$data.longSpeech,
          context = _this$data.context;
      this.voiceRecognizer.start({
        mode: mode,
        longSpeech: longSpeech,
        context: context
      });
    },
    stop: function stop() {
      var _this2 = this;

      var content = this.data.content;

      if (content) {
        setTimeout(function () {
          _this2.triggerEvent('stop', {
            content: content
          });
        }, 300);
        this.finish();
      } else {
        this.setData({
          msg: _const.TIPS.RETRY,
          btnText: _const.BTN_TEXT.START,
          eventType: 'start',
          showAnimate: 2
        });
        this.voiceRecognizer.stop();
      }
    },
    finish: function finish() {
      this.voiceRecognizer.stop();
      this.endAnimation();
    },
    cancel: function cancel() {
      var _this3 = this;

      this.voiceRecognizer.cancel();
      this.endAnimation(function () {
        _this3.triggerEvent('cancelend');
      });
    },
    startAnimation: function startAnimation() {
      var animation = swan.createAnimation(this.data.animateParam);
      animation.translateY(0).step();
      this.setData({
        animationData: animation["export"]()
      });
    },
    endAnimation: function endAnimation(callback) {
      var _this4 = this;

      var animation = swan.createAnimation(this.data.animateParam);
      animation.translateY(290).step();
      this.setData({
        animationData: animation["export"]()
      }, function () {
        setTimeout(function () {
          _this4.panelInit();

          _this4.data.hasTabBar && swan.showTabBar({
            animation: true
          });
          callback && callback();
        }, 200);
      });
    },
    panelInit: function panelInit() {
      this.setData({
        showPanel: false,
        showAnimate: 0,
        verticalAlign: _const.JUSTIFY_CONTENT.NORMAL,
        content: '',
        msg: this.data.defaultText,
        btnText: _const.BTN_TEXT.END,
        eventType: '',
        delMargin: false
      });
    },
    errInit: function errInit() {
      this.setData({
        verticalAlign: _const.JUSTIFY_CONTENT.NORMAL,
        content: '',
        btnText: _const.BTN_TEXT.START,
        eventType: 'start',
        delMargin: false
      });
    },
    promptConversion: function promptConversion(errCode, errorMsg) {
      var text = '';

      switch (errCode) {
        case 2001:
          text = _const.TIPS.ABNORMAL_MIKE;
          break;

        case 2002:
          text = _const.TIPS.RETRY;
          break;

        case 2003:
          text = _const.TIPS.TOO_SHORT;
          break;

        case 2004:
        case 2005:
          text = '';
          break;

        case 1001:
        case 2009:
        case 3001:
        case 3002:
        case 9000:
          text = _const.TIPS.TRY_AGIN;
          break;

        case 4002:
          text = _const.TIPS.TOO_LONG;
          break;

        case 4001:
        case 4003:
        case 4004:
          text = _const.TIPS.FAIL;
          break;

        default:
          text = errorMsg;
      }

      return text;
    }
  }
});